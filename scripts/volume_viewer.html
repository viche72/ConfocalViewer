<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>3-D Volume Viewer (Hosted with Server File List)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Libraries -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://unpkg.com/fflate@0.8.2/umd/index.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; background: #111; color: #fff; }
    main { padding: 12px 16px; }
    #controls, #chan, #tone { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    #viewer { width: 100%; height: 58vh; }
    #mips { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
    .box { background: #f7f7f7; padding: 8px; border-radius: 8px; }
    input[type="file"]{ display:none; }
    .btn { border: 0; background: #2563eb; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    label { font-weight: 600; }
    select, input[type="number"], input[type="color"], input[type="text"] { padding: 6px; border-radius: 8px; }
    .pill { background:#f0f0f0; padding:6px 10px; border-radius:999px; display:inline-block; }
    img { width: 100%; height: auto; border-radius: 6px; }
    .small { width:5rem; } .tight { width:4.5rem; }
    #serverfile { width: 18rem; }
  </style>
</head>
<body>
<header>
  <h2>3-D Volume Viewer</h2>
  <div>Load NPZ from this folder (server), via dropdown, URL <code>?file=Your.npz</code>, text box, drag-drop, or local picker.</div>
</header>

<main>
  <div id="controls">
    <label class="btn"><input id="files" type="file" accept=".npz" multiple>Load NPZ(s)</label>

    <label>Server files
      <select id="serverlist">
        <option value="">— (none found yet) —</option>
      </select>
    </label>
    <button id="refresh" class="btn" title="Refresh server file list">Refresh</button>

    <label>Server file <input id="serverfile" type="text" placeholder="example.npz"></label>
    <button id="loadServer" class="btn">Load from server</button>

    <label>Dataset <select id="dataset"></select></label>
    <span id="meta" class="pill">No file loaded</span>
    <label>Isosurfaces <input id="surface_count" type="number" value="10" class="small"></label>
    <button id="savepng" class="btn" disabled>Save PNG</button>
  </div>

  <div id="chan" class="box">
    <div>
      <input type="checkbox" id="toggle_r" checked> <label for="toggle_r">Red (Ch3)</label>
      <input id="color_r" type="color" value="#ff0000" title="Red color">
      Isomin <input id="isomin_r" type="number" step="0.01" value="0.20" class="tight">
      Opacity <input id="opacity_r" type="number" step="0.01" value="0.06" class="tight">
    </div>
    <div>
      <input type="checkbox" id="toggle_g" checked> <label for="toggle_g">Green (Ch1)</label>
      <input id="color_g" type="color" value="#00ff00" title="Green color">
      Isomin <input id="isomin_g" type="number" step="0.01" value="0.20" class="tight">
      Opacity <input id="opacity_g" type="number" step="0.01" value="0.06" class="tight">
    </div>
    <div>
      <input type="checkbox" id="toggle_b" checked> <label for="toggle_b">Blue (Ch2)</label>
      <input id="color_b" type="color" value="#0000ff" title="Blue color">
      Isomin <input id="isomin_b" type="number" step="0.01" value="0.20" class="tight">
      Opacity <input id="opacity_b" type="number" step="0.01" value="0.06" class="tight">
    </div>
    <button id="rerender" class="btn" disabled>Re-render</button>
  </div>

  <div id="tone" class="box">
    <div>Contrast Lo <input id="lo" type="number" step="0.01" value="0.00" class="tight"></div>
    <div>Hi <input id="hi" type="number" step="0.01" value="1.00" class="tight"></div>
    <div>Gamma <input id="gamma" type="number" step="0.05" value="1.00" class="tight"></div>
    <small>(Applied to all channels: v' = clip((v - lo)/(hi - lo))^gamma)</small>
  </div>

  <div id="viewer" class="box"></div>

  <div id="mips">
    <div class="box"><div style="font-weight:600;margin-bottom:4px;">XY MIP</div><img id="mip_xy" alt="XY MIP"></div>
    <div class="box"><div style="font-weight:600;margin-bottom:4px;">XZ MIP</div><img id="mip_xz" alt="XZ MIP"></div>
    <div class="box"><div style="font-weight:600;margin-bottom:4px;">YZ MIP</div><img id="mip_yz" alt="YZ MIP"></div>
  </div>
</main>

<script>
/* ------------------- State ------------------- */
let datasets = []; // {name, r:{data,shape}, g, b, meta}
let current = -1;

/* ------------------- NPY/NPZ helpers ------------------- */
function parseNPY(buffer) {
  const u8 = new Uint8Array(buffer);
  if (!(u8[0] === 0x93 && u8[1]===0x4E && u8[2]===0x55 && u8[3]===0x4D && u8[4]===0x50 && u8[5]===0x59)) {
    throw new Error("Not an NPY file");
  }
  const verMajor = u8[6], verMinor = u8[7];
  let headerLen, headerStart;
  if (verMajor === 1) { headerLen = new DataView(buffer, 8, 2).getUint16(0, true); headerStart = 10; }
  else if (verMajor === 2) { headerLen = new DataView(buffer, 8, 4).getUint32(0, true); headerStart = 12; }
  else { throw new Error("Unsupported NPY version: " + verMajor + "." + verMinor); }
  const header = new TextDecoder().decode(new Uint8Array(buffer, headerStart, headerLen));
  const descr = /'descr':\s*'([^']+)'/.exec(header)?.[1];
  const shapeStr = /'shape':\s*\(([^)]+)\)/.exec(header)?.[1];
  const fortran = /'fortran_order':\s*(True|False)/.exec(header)?.[1] === "True";
  if (!descr || !shapeStr || fortran === undefined) throw new Error("Invalid NPY header");
  const typeChar = descr.replace(/[<\|>]/g, '');
  const littleEndian = descr.startsWith('<') || descr.startsWith('|');
  if (!littleEndian) throw new Error("Big-endian arrays not supported");
  const shape = shapeStr.split(',').map(s => s.trim()).filter(Boolean).map(s => parseInt(s));
  const dataStart = headerStart + headerLen;
  let arr;
  if (typeChar === 'f4')      arr = new Float32Array(buffer, dataStart);
  else if (typeChar === 'f8') arr = new Float64Array(buffer, dataStart);
  else if (typeChar === 'u1') arr = new Uint8Array(buffer, dataStart);
  else throw new Error("Unsupported dtype "+typeChar);
  return { data: arr, shape };
}
function toBuffer(u8) { return u8.buffer.slice(u8.byteOffset, u8.byteOffset + u8.byteLength); }

async function loadNPZFromArrayBuffer(ab, name) {
  const u8 = new Uint8Array(ab);
  if (!(u8[0] === 0x50 && u8[1] === 0x4B)) throw new Error("Not a ZIP/NPZ (no 'PK' signature)");
  const unzipped = fflate.unzipSync(u8);
  const need = ['r.npy','g.npy','b.npy','meta.json'];
  for (const k of need) if (!(k in unzipped)) throw new Error("Missing '"+k+"' inside NPZ");
  const r = parseNPY(toBuffer(unzipped['r.npy']));
  const g = parseNPY(toBuffer(unzipped['g.npy']));
  const b = parseNPY(toBuffer(unzipped['b.npy']));
  const meta = JSON.parse(new TextDecoder().decode(toBuffer(unzipped['meta.json'])));
  const idx = datasets.push({name, r, g, b, meta}) - 1;
  const sel = document.getElementById('dataset');
  const o = document.createElement('option'); o.value = String(idx); o.textContent = name; sel.appendChild(o);
  if (current < 0) { current = idx; sel.value = String(idx); updateMeta(); render(); enableControls(true); }
}

async function loadNPZFromServer(relativePath) {
  const res = await fetch(relativePath, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} for ${relativePath}`);
  const ab = await res.arrayBuffer();
  await loadNPZFromArrayBuffer(ab, relativePath);
}

async function onFilesSelected(fileList) {
  datasets = []; current = -1; document.getElementById('dataset').innerHTML = '';
  for (const f of fileList) {
    const ab = await f.arrayBuffer();
    await loadNPZFromArrayBuffer(ab, f.name);
  }
  if (!datasets.length) enableControls(false);
}

/* ------------------- UI helpers ------------------- */
function enableControls(on) {
  ['rerender','savepng','toggle_r','toggle_g','toggle_b','isomin_r','isomin_g','isomin_b',
   'opacity_r','opacity_g','opacity_b','surface_count','color_r','color_g','color_b',
   'lo','hi','gamma','dataset','serverfile','loadServer','serverlist','refresh'].forEach(id=>{
    document.getElementById(id).disabled = !on && !['serverfile','loadServer','serverlist','refresh'].includes(id);
  });
}
function updateMeta() {
  const ds = datasets[current];
  const m = ds.meta;
  const effX = (m.vx_um * (m.ds||1)).toFixed(3);
  const effY = (m.vy_um * (m.ds||1)).toFixed(3);
  const effZ = (m.vz_um).toFixed(3);
  document.getElementById('meta').textContent =
    `Z×Y×X=${ds.r.shape.join('×')} | voxel µm (eff): X=${effX}, Y=${effY}, Z=${effZ} | ${m.file||ds.name}`;
}

/* ------------------- Geometry & tone mapping ------------------- */
function makeCoords(Z, Y, X, vx, vy, vz) {
  const x = new Float32Array(X*Y*Z), y = new Float32Array(X*Y*Z), z = new Float32Array(X*Y*Z);
  let idx=0; for (let k=0;k<Z;k++) for (let j=0;j<Y;j++) for (let i=0;i<X;i++) { x[idx]=i*vx; y[idx]=j*vy; z[idx]=k*vz; idx++; }
  return {x,y,z};
}
function applyTone(src, lo, hi, gamma) {
  const n = src.length, out = new Float32Array(n);
  const a = 1.0/Math.max(1e-6,(hi-lo)), g=Math.max(gamma,1e-6);
  for (let i=0;i<n;i++){ let v=(src[i]-lo)*a; if(v<0)v=0; else if(v>1)v=1; out[i]=Math.pow(v,g); }
  return out;
}
function hexToRgb(hex){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(!m) return [255,255,255];
  return [parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)]; }
function colorScaleFromHex(hex){ const [r,g,b]=hexToRgb(hex); return [[0,'rgb(0,0,0)'],[1,`rgb(${r},${g},${b})`]]; }

/* ------------------- MIP generation ------------------- */
function toImageData(rgb,w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
  const img=ctx.createImageData(w,h); img.data.set(rgb); ctx.putImageData(img,0,0); return c.toDataURL(); }
function mipRGB(ds, lo, hi, gamma){
  const Z=ds.r.shape[0], Y=ds.r.shape[1], X=ds.r.shape[2];
  const r=applyTone(ds.r.data,lo,hi,gamma), g=applyTone(ds.g.data,lo,hi,gamma), b=applyTone(ds.b.data,lo,hi,gamma);
  const xy=new Uint8ClampedArray(X*Y*4), xz=new Uint8ClampedArray(X*Z*4), yz=new Uint8ClampedArray(Y*Z*4);
  for(let j=0;j<Y;j++) for(let i=0;i<X;i++){ let rmax=0,gmax=0,bmax=0;
    for(let k=0;k<Z;k++){ const idx=k*Y*X+j*X+i; rmax=Math.max(rmax,r[idx]*255); gmax=Math.max(gmax,g[idx]*255); bmax=Math.max(bmax,b[idx]*255); }
    const p=(j*X+i)*4; xy[p]=rmax; xy[p+1]=gmax; xy[p+2]=bmax; xy[p+3]=255; }
  for(let k=0;k<Z;k++) for(let i=0;i<X;i++){ let rmax=0,gmax=0,bmax=0;
    for(let j=0;j<Y;j++){ const idx=k*Y*X+j*X+i; rmax=Math.max(rmax,r[idx]*255); gmax=Math.max(gmax,g[idx]*255); bmax=Math.max(bmax,b[idx]*255); }
    const p=(k*X+i)*4; xz[p]=rmax; xz[p+1]=gmax; xz[p+2]=bmax; xz[p+3]=255; }
  for(let k=0;k<Z;k++) for(let j=0;j<Y;j++){ let rmax=0,gmax=0,bmax=0;
    for(let i=0;i<X;i++){ const idx=k*Y*X+j*X+i; rmax=Math.max(rmax,r[idx]*255); gmax=Math.max(gmax,g[idx]*255); bmax=Math.max(bmax,b[idx]*255); }
    const p=(k*Y+j)*4; yz[p]=rmax; yz[p+1]=gmax; yz[p+2]=bmax; yz[p+3]=255; }
  return { xy:toImageData(xy,X,Y), xz:toImageData(xz,X,Z), yz:toImageData(yz,Y,Z) };
}

/* ------------------- Render ------------------- */
function render(){
  if(current<0) return;
  const ds=datasets[current]; const Z=ds.r.shape[0], Y=ds.r.shape[1], X=ds.r.shape[2];
  const m=ds.meta; const vx=m.vx_um*(m.ds||1), vy=m.vy_um*(m.ds||1), vz=m.vz_um;
  const {x,y,z}=makeCoords(Z,Y,X,vx,vy,vz);
  const sc=parseInt(document.getElementById('surface_count').value,10);
  const lo=parseFloat(document.getElementById('lo').value), hi=parseFloat(document.getElementById('hi').value), gamma=parseFloat(document.getElementById('gamma').value);
  const r=applyTone(ds.r.data,lo,hi,gamma), g=applyTone(ds.g.data,lo,hi,gamma), b=applyTone(ds.b.data,lo,hi,gamma);
  const traces=[];
  function add(values,name,hex,isomin,opacity,on) {
    if(!on) return;
    traces.push({ type:'volume', x,y,z, value:values, cmin:0,cmax:1, isomin, isomax:1, opacity,
                  surface_count:sc, colorscale:colorScaleFromHex(hex), showscale:false, name });
  }
  add(r,'Red (Ch3)',document.getElementById('color_r').value,
      parseFloat(document.getElementById('isomin_r').value), parseFloat(document.getElementById('opacity_r').value),
      document.getElementById('toggle_r').checked);
  add(g,'Green (Ch1)',document.getElementById('color_g').value,
      parseFloat(document.getElementById('isomin_g').value), parseFloat(document.getElementById('opacity_g').value),
      document.getElementById('toggle_g').checked);
  add(b,'Blue (Ch2)',document.getElementById('color_b').value,
      parseFloat(document.getElementById('isomin_b').value), parseFloat(document.getElementById('opacity_b').value),
      document.getElementById('toggle_b').checked);

  Plotly.newPlot('viewer', traces, {
    title: `${m.file || datasets[current].name}`,
    scene: { xaxis:{title:'X (µm)'}, yaxis:{title:'Y (µm)'}, zaxis:{title:'Z (µm)'}, aspectmode:'data' }
  }, {responsive:true}).then(()=>{ document.getElementById('savepng').disabled = true; document.getElementById('savepng').disabled = false; });

  const mips=mipRGB(ds,lo,hi,gamma);
  document.getElementById('mip_xy').src=mips.xy;
  document.getElementById('mip_xz').src=mips.xz;
  document.getElementById('mip_yz').src=mips.yz;
}

function savePNG(){
  const gd=document.getElementById('viewer').querySelector('.js-plotly-plot');
  if (!gd) return;
  Plotly.downloadImage(gd,{format:'png', filename:'volume_snapshot', width:1200, height:800});
}

/* ------------------- Server file discovery ------------------- */
/* Strategy:
   1) Try npz_manifest.json (JSON array of filenames, e.g. ["A.npz","B.npz"]).
   2) Else try to fetch the current directory index (if auto-index is enabled) and parse anchor tags ending .npz.
*/
async function discoverServerNPZs() {
  // Try manifest first
  try {
    const r = await fetch('npz_manifest.json', {cache:'no-store'});
    if (r.ok) {
      const list = await r.json();
      return Array.isArray(list) ? list.filter(n => typeof n === 'string' && n.toLowerCase().endsWith('.npz')) : [];
    }
  } catch (_) {}
  // Fallback: parse auto-index HTML
  try {
    const r = await fetch('./', {cache:'no-store'});
    if (r.ok) {
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('text/html')) {
        const txt = await r.text();
        const doc = new DOMParser().parseFromString(txt, 'text/html');
        const as = Array.from(doc.querySelectorAll('a[href]'));
        const files = as.map(a => a.getAttribute('href'))
          .filter(href => !!href)
          .map(href => href.split('?')[0].split('#')[0])
          .filter(href => href.toLowerCase().endsWith('.npz'))
          .map(href => href.substring(href.lastIndexOf('/')+1)); // keep base name only
        // Deduplicate and sort
        return Array.from(new Set(files)).sort();
      }
    }
  } catch (_) {}
  return [];
}

async function refreshServerList() {
  const sel = document.getElementById('serverlist');
  sel.innerHTML = '<option value="">— (loading…) —</option>';
  const files = await discoverServerNPZs();
  sel.innerHTML = '';
  if (!files.length) {
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = '— (no .npz found) —';
    sel.appendChild(opt);
    return;
  }
  const placeholder = document.createElement('option');
  placeholder.value = ''; placeholder.textContent = '— select a file —';
  sel.appendChild(placeholder);
  for (const f of files) {
    const o = document.createElement('option');
    o.value = f; o.textContent = f;
    sel.appendChild(o);
  }
}

/* ------------------- Events ------------------- */
document.getElementById('files').addEventListener('change', e => onFilesSelected(e.target.files));
document.getElementById('dataset').addEventListener('change', e => { current = parseInt(e.target.value, 10); updateMeta(); render(); });
document.getElementById('rerender').addEventListener('click', render);
document.getElementById('savepng').addEventListener('click', savePNG);
document.getElementById('loadServer').addEventListener('click', async ()=>{
  const name = document.getElementById('serverfile').value.trim();
  if (!name) return;
  try { await loadNPZFromServer(name); } catch (e) { alert('Failed to load '+name+': '+e.message); }
});
document.getElementById('serverlist').addEventListener('change', async (e)=>{
  const name = e.target.value;
  if (!name) return;
  document.getElementById('serverfile').value = name;
  try { await loadNPZFromServer(name); } catch (e2) { alert('Failed to load '+name+': '+e2.message); }
});
document.getElementById('refresh').addEventListener('click', refreshServerList);

/* Drag & drop */
document.addEventListener('dragover', e=>{ e.preventDefault(); });
document.addEventListener('drop', async e=>{
  e.preventDefault();
  const files=[...e.dataTransfer.files].filter(f=>f.name.toLowerCase().endswith('.npz'));
  if(files.length){ await onFilesSelected(files); }
});

/* Autoload via ?file= or ?files= */
(async function init(){
  await refreshServerList();
  const params = new URLSearchParams(location.search);
  const single = params.get('file');
  const multi = params.get('files');
  if (single) {
    document.getElementById('serverfile').value = single;
    try { await loadNPZFromServer(single); } catch (e) { /* ignore */ }
  } else if (multi) {
    for (const f of multi.split(',').map(s=>s.trim()).filter(Boolean)) {
      try { await loadNPZFromServer(f); } catch (e) { /* ignore each */ }
    }
  }
})();
</script>
</body>
</html>
